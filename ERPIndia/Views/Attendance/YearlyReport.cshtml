@model ERPIndia.Models.Attendance.YearlyAttendanceViewModel
@{
    ViewBag.Title = "Yearly Attendance";
}

<style>
  
    /* Header Card Styling */
    .filter-card {
        background: linear-gradient(to bottom, #ffffff, #f8f9fa);
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    }

    /* Table Styling */
    .yearly-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 12px;
    }

        .yearly-table thead th {
            background: linear-gradient(to bottom, #f0f0f0, #e0e0e0, #d0d0d0);
            color: black !important;
            padding: 8px 5px;
            text-align: center;
            font-size: 11px;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
            border: 1px solid #999 !important;
        }

        .yearly-table tbody tr:nth-child(odd) {
            background-color: #ffffff;
        }

        .yearly-table tbody tr:nth-child(even) {
            background-color: #f8f9fa;
        }

        .yearly-table tbody tr:hover {
            background-color: #e8e8e8;
        }

        .yearly-table tbody td {
            padding: 6px 4px;
            border: 1px solid #999;
            text-align: center;
            font-size: 11px;
            color: black !important;
        }

    /* Month headers */
    .month-header {
        background: #e0e0e0 !important;
        color: black !important;
        font-weight: bold;
        padding: 5px 2px;
    }

    .sub-header {
        background: #f0f0f0 !important;
        color: black !important;
        font-size: 10px;
        padding: 4px 2px;
        font-weight: 600;
    }

    /* Button Styling */
    .search-button {
        background: linear-gradient(to bottom, #1c79eb, #2c78bf, #155ab5);
        color: white !important;
        padding: 0.5rem 1.5rem;
        border: none;
        border-radius: 5px;
        font-weight: bold;
        cursor: pointer;
        transition: transform 0.2s;
    }

        .search-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

    /* Export button - ensure visibility */
    .btn-success {
        background-color: #28a745 !important;
        border-color: #28a745 !important;
        color: white !important;
        padding: 6px 12px;
        font-size: 14px;
        border-radius: 4px;
        cursor: pointer;
        display: inline-block !important;
        visibility: visible !important;
    }

        .btn-success:hover {
            background-color: #218838 !important;
            border-color: #1e7e34 !important;
        }

        .btn-success i {
            color: white !important;
        }

    /* Summary cards */
    .summary-card {
        background: white;
        border-radius: 8px;
        padding: 15px;
        margin: 10px 0;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .summary-stat {
        display: inline-block;
        margin: 0 15px;
    }

    .stat-label {
        color: black !important;
        font-size: 12px;
    }

    .stat-value {
        font-size: 20px;
        font-weight: bold;
        color: black !important;
    }

    /* Spinner */
    .spinner-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 9999;
    }

    .spinner-box {
        background: white;
        padding: 30px;
        border-radius: 10px;
        text-align: center;
        color: black !important;
    }

    .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #9c27b0;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 15px;
    }

    @@keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }

    /* Toast notifications */
    .toast-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 99999;
    }

    .toast {
        min-width: 300px;
        padding: 15px;
        margin-bottom: 10px;
        border-radius: 5px;
        animation: slideIn 0.3s;
        font-weight: 500;
        font-size: 14px;
        color: black !important;
    }

    .toast-success {
        background: #d4edda;
        border-left: 4px solid #28a745;
    }

    .toast-error {
        background: #f8d7da;
        border-left: 4px solid #dc3545;
    }

    .toast-warning {
        background: #fff3cd;
        border-left: 4px solid #ffc107;
    }

    .toast-info {
        background: #d1ecf1;
        border-left: 4px solid #17a2b8;
    }

    @@keyframes slideIn {
        from {
            transform: translateX(100%);
            opacity: 0;
        }

        to {
            transform: translateX(0);
            opacity: 1;
        }
    }

    /* Print styles */
    @@media print {
        .no-print {
            display: none !important;
        }

        .yearly-table {
            font-size: 10px;
        }

            .yearly-table thead th {
                font-size: 9px;
                color: black !important;
            }

            .yearly-table tbody td {
                color: black !important;
            }
    }

    /* Performance badge */
    .performance-badge {
        padding: 2px 6px;
        border-radius: 3px;
        font-size: 10px;
        font-weight: bold;
        color: black !important;
        background: #f0f0f0 !important;
        border: 1px solid #999;
    }

    /* Ensure all form controls have black text */
    .form-select, .form-label {
        color: black !important;
    }
</style>

<div class="container-fluid">
    <!-- Header Card -->
    <div class="card no-print">
        <div class="card-header bg-light">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-line me-2"></i>Yearly Attendance
                </h5>
            </div>
        </div>
        <div class="card-body">
            <form id="searchForm" class="needs-validation" novalidate>
                <div class="row g-3">
                    <div class="col-md-3">
                        <label for="ddlClass" class="form-label">Class <span class="text-danger">*</span></label>
                        @Html.DropDownListFor(m => m.Classes, Model.Classes, "Select Class", new { @class = "form-select", id = "ddlClass" })
                    </div>
                    <div class="col-md-3">
                        <label for="ddlSection" class="form-label">Section <span class="text-danger">*</span></label>
                        @Html.DropDownListFor(m => m.Sections, Model.Sections, "Select Section", new { @class = "form-select", id = "ddlSection" })
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">&nbsp;</label>
                        <button type="button" class="btn search-button w-100" id="btnSearch">
                            <i class="fas fa-search me-2"></i>Generate Report
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Report Table -->
    <div id="reportContainer" class="mt-4" style="display:none;">
        <div class="card">
            <div class="card-header bg-light">
                <div class="row align-items-center">
                    <div class="col-6">
                        <h6 class="mb-0">
                            <i class="fas fa-table me-2"></i>Attendance Details
                        </h6>
                    </div>
                    <div class="col-6 text-end">
                        <button type="button" class="btn btn-success btn-sm" onclick="exportToExcel()" style="display: inline-block !important; visibility: visible !important;">
                            <i class="fas fa-file-excel me-1"></i>Export to Excel
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body">
               <!-- Table -->
                <div class="table-responsive">
                    <table class="yearly-table" id="yearlyAttendanceTable">
                        <thead id="tableHeader">
                            <!-- Dynamic headers will be generated here -->
                        </thead>
                        <tbody id="tableBody">
                            <!-- Data will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Toast Container -->
<div class="toast-container" id="toastContainer"></div>

<!-- Spinner Overlay -->
<div class="spinner-overlay" id="spinnerOverlay">
    <div class="spinner-box">
        <div class="spinner"></div>
        <div>Generating yearly report...</div>
    </div>
</div>

<script>
$(document).ready(function() {
    var reportData = null;
    var dataTable = null;

    // Toast notification
    function showToast(message, type, duration) {
        type = type || 'success';
        duration = duration || 4000;

        var icons = {
            success: 'check-circle',
            error: 'times-circle',
            warning: 'exclamation-triangle',
            info: 'info-circle'
        };

        var toastId = 'toast_' + Date.now();
        var toastHtml =
            '<div class="toast toast-' + type + '" id="' + toastId + '" style="display:none;">' +
                '<i class="fas fa-' + icons[type] + ' me-2"></i>' +
                message +
            '</div>';

        $('#toastContainer').append(toastHtml);
        $('#' + toastId).fadeIn(300);

        setTimeout(function() {
            $('#' + toastId).fadeOut(300, function() {
                $(this).remove();
            });
        }, duration);
    }

    // Show/Hide spinner
    function showSpinner() {
        $('#spinnerOverlay').css('display', 'flex');
    }

    function hideSpinner() {
        $('#spinnerOverlay').hide();
    }

    // Clear existing data
    function clearExistingData() {
        if (dataTable) {
            dataTable.destroy();
            dataTable = null;
        }

        $('#tableHeader').empty();
        $('#tableBody').empty();
        reportData = null;
    }

    // Search button click
    $('#btnSearch').click(function() {
        var classId = $('#ddlClass').val();
        var sectionId = $('#ddlSection').val();
      
        if (!classId || !sectionId) {
            showToast('Please select all required fields', 'warning');
            return;
        }

        clearExistingData();
        loadYearlyReport(classId, sectionId);
    });

    // Load yearly report
    function loadYearlyReport(classId, sectionId) {
        showSpinner();
        $('#reportContainer').hide();

        $.ajax({
            url: '@Url.Action("GetYearlyAttendanceReport", "Attendance")',
            type: 'POST',
            data: {
                classId: classId,
                sectionId: sectionId
            },
            cache: false,
            success: function(response) {
                hideSpinner();

                if (response.success) {
                    reportData = response.data;
                    displayReport(reportData);
                    $('#reportContainer').show();
                    showToast('Report generated successfully!', 'success');
                } else {
                    showToast(response.message || 'Failed to generate report', 'error');
                    clearExistingData();
                    $('#reportContainer').hide();
                }
            },
            error: function(xhr, status, error) {
                hideSpinner();
                showToast('Error generating report: ' + error, 'error');
                console.error('Error:', error);
                clearExistingData();
                $('#reportContainer').hide();
            }
        });
    }

    // Display report with April to March order and only P, L, HD columns
    // Display report with April to March order and only P, L, HD columns
    function displayReport(data) {
        $('#tableHeader').empty();
        $('#tableBody').empty();

        if (dataTable) {
            dataTable.destroy();
            dataTable = null;
        }

        // Build table headers (April to March)
        var headerHtml = '<tr>';
        headerHtml += '<th rowspan="2">Sr</th>';
        headerHtml += '<th rowspan="2">Adm.</th>';
        headerHtml += '<th rowspan="2">Roll</th>';
        headerHtml += '<th rowspan="2">Student Name</th>';
        headerHtml += '<th rowspan="2">Father Name</th>';

        // Month headers (April to March)
        var months = ['Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep',
            'Oct', 'Nov', 'Dec', 'Jan', 'Feb', 'Mar'];

        $.each(months, function (i, month) {
            headerHtml += '<th colspan="4" class="month-header">' + month + '</th>';
        });

        headerHtml += '<th colspan="4">Yearly Total</th>';
        headerHtml += '<th rowspan="2">%</th>';
        headerHtml += '<th rowspan="2">Grade</th>';
        headerHtml += '</tr>';

        // Sub headers (WD, P, L, HD only - no Absent)
        headerHtml += '<tr>';
        for (var i = 0; i < 12; i++) {
            headerHtml += '<th class="sub-header">WD</th>';
            headerHtml += '<th class="sub-header">P</th>';
            headerHtml += '<th class="sub-header">L</th>';
            headerHtml += '<th class="sub-header">HD</th>';
        }
        headerHtml += '<th class="sub-header">WD</th>';
        headerHtml += '<th class="sub-header">P</th>';
        headerHtml += '<th class="sub-header">L</th>';
        headerHtml += '<th class="sub-header">HD</th>';
        headerHtml += '</tr>';

        $('#tableHeader').html(headerHtml);

        // Build table body
        var bodyHtml = '';

        if (data.Students && data.Students.length > 0) {
            $.each(data.Students, function (index, student) {
                var attendancePercentage = parseFloat(student.AttendancePercentage) || 0;

                bodyHtml += '<tr>';
                bodyHtml += '<td>' + (student.SerialNo || (index + 1)) + '</td>';
                bodyHtml += '<td>' + (student.AdmissionNo || '-') + '</td>';
                bodyHtml += '<td>' + (student.RollNumber || '-') + '</td>';
                bodyHtml += '<td>' + (student.StudentName || '-') + '</td>';
                bodyHtml += '<td>' + (student.FatherName || '-') + '</td>';

                // Monthly data - NO REORDERING NEEDED! Backend already sends in correct order
                if (student.MonthlyData && student.MonthlyData.length === 12) {
                    for (var i = 0; i < 12; i++) {
                        var monthData = student.MonthlyData[i]; // Use index directly, no reordering
                        if (monthData) {
                            bodyHtml += '<td>' + (monthData.WorkingDays || 0) + '</td>';
                            bodyHtml += '<td>' + (monthData.Present || 0) + '</td>';
                            bodyHtml += '<td>' + (monthData.Late || 0) + '</td>';
                            bodyHtml += '<td>' + (monthData.HalfDay || 0) + '</td>';
                        } else {
                            bodyHtml += '<td>0</td><td>0</td><td>0</td><td>0</td>';
                        }
                    }
                } else {
                    // Fill with zeros if data is missing
                    for (var m = 0; m < 12; m++) {
                        bodyHtml += '<td>0</td><td>0</td><td>0</td><td>0</td>';
                    }
                }

                // Yearly totals (no Absent column)
                bodyHtml += '<td><strong>' + (student.TotalWorkingDays || 0) + '</strong></td>';
                bodyHtml += '<td><strong>' + (student.TotalPresent || 0) + '</strong></td>';
                bodyHtml += '<td><strong>' + (student.TotalLate || 0) + '</strong></td>';
                bodyHtml += '<td><strong>' + (student.TotalHalfDay || 0) + '</strong></td>';

                // Percentage
                bodyHtml += '<td><strong>' + attendancePercentage.toFixed(2) + '%</strong></td>';

                // Grade
                var gradeText = student.AttendanceGrade || 'N/A';
                bodyHtml += '<td><span class="performance-badge">' + gradeText + '</span></td>';
                bodyHtml += '</tr>';
            });
        } else {
            bodyHtml = '<tr><td colspan="57" class="text-center">No data available</td></tr>';
        }

        $('#tableBody').html(bodyHtml);
    }

    // Export to Excel function
    window.exportToExcel = function() {
        var classId = $('#ddlClass').val();
        var sectionId = $('#ddlSection').val();
       
        if (!classId || !sectionId) {
            showToast('Please generate the report first', 'warning');
            return;
        }

        showSpinner();

        $.ajax({
            url: '@Url.Action("ExportYearlyAttendanceToExcel", "Attendance")',
            type: 'POST',
            data: {
                classId: classId,
                sectionId: sectionId
            },
            success: function(response) {
                hideSpinner();
                if (response.success) {
                    // Download the file
                    var link = document.createElement('a');
                    link.href = 'data:application/vnd.openxmlformats-officedocument.spreadsheetml.sheet;base64,' + response.fileContent;
                    link.download = response.fileName;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);

                    showToast('Excel file downloaded successfully!', 'success');
                } else {
                    showToast('Failed to export: ' + response.message, 'error');
                }
            },
            error: function(xhr, status, error) {
                hideSpinner();
                showToast('Error exporting to Excel: ' + error, 'error');
            }
        });
    };

    // Hide containers and clear data when filters change
    $('#ddlClass, #ddlSection, #ddlYear').change(function() {
        $('#reportContainer').hide();
        clearExistingData();
    });

    // Prevent form submission on Enter key
    $('#searchForm').on('submit', function(e) {
        e.preventDefault();
        $('#btnSearch').click();
        return false;
    });
});
</script>