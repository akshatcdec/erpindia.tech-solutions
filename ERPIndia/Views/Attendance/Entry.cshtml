@model ERPIndia.Models.Attendance.AttendanceViewModel
@{
    ViewBag.Title = "Attendance Entry";
}

<!-- Add Flatpickr CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

<style>
    /* Header Styling */
    .filter-card {
        background: linear-gradient(to bottom, #ffffff, #f8f9fa);
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    }

    /* Table Styling */
    /* Table Styling */
    .attendance-table {
        width: 100%;
        border-collapse: collapse;
    }

        .attendance-table thead th {
            background: linear-gradient(to bottom, #1c79eb, #2c78bf, #155ab5);
            color: white !important;
            padding: 12px 10px;
            text-align: center;
            font-size: 14px;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
            border: 1px solid #ddd !important;
        }

        .attendance-table tbody tr:nth-child(odd) {
            background-color: #ffffff;
        }

        .attendance-table tbody tr:nth-child(even) {
            background-color: #f8f9fa;
        }

        .attendance-table tbody tr:hover {
            background-color: #e3f2fd;
        }

        .attendance-table tbody tr.selected-row {
            background-color: #e3f2fd !important;
        }

        .attendance-table tbody td {
            padding: 8px;
            border: 1px solid #dee2e6;
            text-align: center;
        }

    /* Status Dropdown Styling */
    .status-dropdown {
        width: 100%;
        padding: 6px;
        border: 1px solid #ced4da;
        border-radius: 4px;
        font-size: 14px;
        cursor: pointer;
    }

        .status-dropdown:focus {
            border-color: #9c27b0;
            box-shadow: 0 0 0 2px rgba(156, 39, 176, 0.1);
            outline: none;
        }

    /* Status Color Coding */
    .status-present {
        background-color: #d4edda;
        color: #155724;
    }

    .status-absent {
        background-color: #f8d7da;
        color: #721c24;
    }

    .status-late {
        background-color: #fff3cd;
        color: #856404;
    }

    .status-halfday {
        background-color: #cce5ff;
        color: #004085;
    }

    .status-holiday {
        background-color: #e2e3e5;
        color: #383d41;
    }

    /* Time Input Styling - Updated for Flatpickr */
    .time-input {
        width: 100px;
        padding: 6px;
        border: 1px solid #ced4da;
        border-radius: 4px;
        font-size: 13px;
        text-align: center;
        background-color: white;
        cursor: pointer;
    }

        .time-input:focus {
            border-color: #9c27b0;
            box-shadow: 0 0 0 2px rgba(156, 39, 176, 0.1);
            outline: none;
        }

    /* Flatpickr custom styling */
    .flatpickr-calendar {
        box-shadow: 0 5px 10px rgba(0,0,0,0.2);
        border-radius: 4px;
    }

    .flatpickr-time {
        border-top: 1px solid #e6e6e6;
    }

    .flatpickr-am-pm {
        cursor: pointer;
    }

    /* Note Input Styling */
    .note-input {
        width: 100%;
        padding: 6px;
        border: 1px solid #ced4da;
        border-radius: 4px;
        font-size: 13px;
    }

    /* Button Styling */
    .search-button {
        background: linear-gradient(to bottom, #1c79eb, #2c78bf, #155ab5);
        color: white;
        padding: 0.5rem 1.5rem;
        border: none;
        border-radius: 5px;
        font-weight: bold;
        cursor: pointer;
        transition: transform 0.2s;
    }

        .search-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        .search-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

    .btn-secondary {
        background: #6c757d;
        color: white;
        padding: 0.5rem 1.5rem;
        border: none;
        border-radius: 5px;
        font-weight: bold;
        cursor: not-allowed;
    }

    .save-button {
        background: linear-gradient(to right, #28a745, #20c997);
        color: white;
        padding: 12px 40px;
        border: none;
        border-radius: 5px;
        font-weight: bold;
        font-size: 16px;
        cursor: pointer;
        transition: all 0.3s;
    }

        .save-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
        }

        .save-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

    .batch-apply-btn {
        background: #17a2b8;
        color: white;
        padding: 8px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-weight: 500;
    }

        .batch-apply-btn:hover {
            background: #138496;
        }

    /* Checkbox Styling */
    .student-checkbox {
        width: 18px;
        height: 18px;
        cursor: pointer;
    }

    /* Toast Styling */
    .toast-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 99999;
    }

    .toast {
        min-width: 300px;
        padding: 15px;
        margin-bottom: 10px;
        border-radius: 5px;
        animation: slideIn 0.3s;
        font-weight: 500;
        font-size: 14px;
    }

    .toast-success {
        background: #d4edda;
        border-left: 4px solid #28a745;
        color: #155724;
    }

    .toast-error {
        background: #f8d7da;
        border-left: 4px solid #dc3545;
        color: #721c24;
    }

    .toast-warning {
        background: #fff3cd;
        border-left: 4px solid #ffc107;
        color: #856404;
    }

    .toast-info {
        background: #d1ecf1;
        border-left: 4px solid #17a2b8;
        color: #0c5460;
    }

    /* Spinner */
    .spinner-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 9999;
    }

    .spinner-box {
        background: white;
        padding: 30px;
        border-radius: 10px;
        text-align: center;
    }

    .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #9c27b0;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 15px;
    }

    @@keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }

    @@keyframes slideIn {
        from {
            transform: translateX(100%);
            opacity: 0;
        }

        to {
            transform: translateX(0);
            opacity: 1;
        }
    }

    #attendanceDataTable tbody tr:nth-child(odd),
    .attendance-table tbody tr:nth-child(odd) {
        background-color: #ffffff !important;
    }
    /* DataTable Button Styling */
    .dataTables_wrapper .dataTables_length select {
        padding: 5px;
        border: 1px solid #ced4da;
        border-radius: 4px;
    }

    .dataTables_wrapper .dataTables_filter input {
        padding: 5px 10px;
        border: 1px solid #ced4da;
        border-radius: 4px;
        margin-left: 10px;
    }

    .dataTables_wrapper .dataTables_info {
        padding: 8px 0;
        font-size: 14px;
        color: #666;
    }

    .dataTables_wrapper .dataTables_paginate {
        padding: 8px 0;
    }

        .dataTables_wrapper .dataTables_paginate .paginate_button {
            padding: 5px 10px;
            margin: 0 2px;
            border: 1px solid #dee2e6;
            border-radius: 3px;
            cursor: pointer;
            background: white;
            color: #495057;
        }

            .dataTables_wrapper .dataTables_paginate .paginate_button.current {
                background: linear-gradient(to bottom, #1c79eb, #155ab5);
                color: white !important;
                border: 1px solid #155ab5;
            }

            .dataTables_wrapper .dataTables_paginate .paginate_button:hover:not(.disabled):not(.current) {
                background: #e9ecef;
                color: #495057;
            }

    /* Student info cell styling */
    .student-info-cell {
        text-align: left !important;
        font-size: 13px;
    }

    /* Summary badges */
    .attendance-summary {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 4px;
        font-size: 12px;
        margin-left: 10px;
    }

    /* Modified row indicator */
    .modified-row {
        border-left: 3px solid #ffc107 !important;
    }

    /* Invalid date selection */
    .border-danger {
        border: 2px solid #dc3545 !important;
        background-color: #fff5f5 !important;
        animation: shake 0.3s;
    }

    @@keyframes shake {
        0%, 100% {
            transform: translateX(0);
        }

        25% {
            transform: translateX(-5px);
        }

        75% {
            transform: translateX(5px);
        }
    }

    /* Date validation message */
    .date-validation-msg {
        color: #dc3545;
        font-size: 12px;
        margin-top: 5px;
        display: none;
        padding: 5px 10px;
        background-color: #f8d7da;
        border-left: 3px solid #dc3545;
        border-radius: 3px;
    }

        .date-validation-msg.show {
            display: block;
            animation: slideDown 0.3s ease;
        }

    @@keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .table.dataTable > tbody > tr:nth-child(odd) td {
        background-color: #f9f9f9; /* light shade */
        color: #515B73;
    }

    .table.dataTable > tbody > tr:nth-child(even) td {
        background-color: lightgray; /* gray shade */
        color: #515B73;
    }

    .table.dataTable > tbody > tr td {
        border-bottom: 1px solid #E9EDF4;
        padding: 12px 20px;
    }

    .date-validation-msg.show {
        display: block;
        animation: slideDown 0.3s ease;
        color: #dc3545 !important; /* Red color for warning */
        font-weight: bold;
    }
</style>

<div class="container-fluid">
    <!-- Header Card -->
    <div class="card">
        <div class="card-header bg-light">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="fas fa-calendar-check me-2"></i>Attendance Entry
                </h5>
            </div>
        </div>
        <div class="card-body">
            <form id="searchForm" class="needs-validation" novalidate>
                <div class="row g-3">
                    <div class="col-md-3">
                        <label for="ddlClass" class="form-label">Class <span class="text-danger">*</span></label>
                        @Html.DropDownListFor(x => x.Classes, Model.Classes, "Select Class", new { @class = "form-select", id = "ddlClass" })
                    </div>
                    <div class="col-md-3">
                        <label for="ddlSection" class="form-label">Section <span class="text-danger">*</span></label>
                        @Html.DropDownListFor(x => x.Sections, Model.Sections, "Select Section", new { @class = "form-select", id = "ddlSection" })
                    </div>
                    <div class="col-md-3">
                        <label for="attendanceDate" class="form-label">Date <span class="text-danger">*</span></label>
                        <input type="date" class="form-control" id="attendanceDate" value="@Model.SelectedDate.ToString("yyyy-MM-dd")" />
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">&nbsp;</label>
                        <button type="button" class="btn search-button w-100" id="btnSearch">
                            <i class="fas fa-search me-2"></i>Search
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Attendance Entry Grid -->
    <div id="attendanceContainer" class="mt-4" style="display:none;">
        <div class="card">
            <div class="card-header bg-light">
                <div class="d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">
                        <i class="fas fa-users me-2"></i>
                        <span id="classInfo"></span>
                        <span class="attendance-summary badge bg-info" id="studentCount">0 students</span>
                        <span class="attendance-summary badge bg-success" id="presentCount">0 present</span>
                        <span class="attendance-summary badge bg-danger" id="absentCount">0 absent</span>
                    </h6>
                    <div>
                        <select id="batchStatus" class="form-select form-select-sm d-inline-block" style="width: 150px;">
                            <option value="">Select Status</option>
                            <option value="Present">Present</option>
                            <option value="Absent">Absent</option>
                            <option value="Late">Late</option>
                            <option value="Half Day">Half Day</option>
                            <option value="Holiday">Holiday</option>
                        </select>
                        <button class="btn btn-sm batch-apply-btn ms-2" onclick="applyBatchStatus()">
                            Apply to Selected
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table attendance-table" id="attendanceDataTable">
                        <thead>
                            <tr id="tableHeader">
                                <th><input type="checkbox" id="selectAll" class="student-checkbox"></th>
                                <th align="center" style="text-align:center">Adm.</th>
                                <th align="center" style="text-align:center">Class</th>
                                <th align="center" style="text-align:center">Mobile</th>
                                <th align="center" style="text-align:center">Name</th>
                                <th align="center" style="text-align:center">Father</th>
                                <th align="center" style="text-align:center">Roll</th>
                                <th width="80" style="text-align:center">Status</th>
                                <th align="center" style="text-align:center">Source</th>
                                <th align="center" style="text-align:center">Time-in</th>
                                <th align="center" style="text-align:center">Time-out</th>
                                <th width="120" style="text-align:center">Note</th>
                            </tr>
                        </thead>
                        <tbody id="attendanceTableBody">
                            <!-- Data will be loaded here -->
                        </tbody>
                    </table>
                </div>
                <div class="text-center mt-4">
                    <button type="button" class="save-button" id="btnSave">
                        <i class="fas fa-save me-2"></i>Save Attendance
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Toast Container -->
<div class="toast-container" id="toastContainer"></div>

<!-- Spinner Overlay -->
<div class="spinner-overlay" id="spinnerOverlay">
    <div class="spinner-box">
        <div class="spinner"></div>
        <div>Loading data...</div>
    </div>
</div>

<!-- Add Flatpickr JS -->
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script>
$(document).ready(function() {
    var dataTable = null;
    var currentClassId = '';
    var currentSectionId = '';
    var currentDate = '';
    var studentsData = [];
    var defaultConfig = {
        DefaultTimeIn: "8:30 AM",
        DefaultTimeOut: "2:45 PM"  // Default fallback values
    };
    var originalAttendance = {};
    var modifiedAttendance = {};
    var flatpickrInstances = {}; // Store Flatpickr instances for cleanup

    // Time conversion helper functions
    function convertTo12Hour(time24) {
        if (!time24) return '08:30 AM';

        // Handle if already in 12-hour format
        if (time24.includes('AM') || time24.includes('PM')) {
            return time24;
        }

        var parts = time24.split(':');
        var hours = parseInt(parts[0]);
        var minutes = parts[1];
        var suffix = hours >= 12 ? 'PM' : 'AM';

        if (hours === 0) {
            hours = 12;
        } else if (hours > 12) {
            hours = hours - 12;
        }

        return hours + ':' + minutes + ' ' + suffix;
    }

    function convertTo24Hour(time12) {
        if (!time12) return '08:30';

        // Handle if already in 24-hour format
        if (!time12.includes('AM') && !time12.includes('PM')) {
            return time12;
        }

        // Clean up the input
        time12 = time12.trim();

        // Split time and modifier (AM/PM)
        var parts = time12.split(' ');
        if (parts.length !== 2) {
            console.error('Invalid time format:', time12);
            return '08:30';
        }

        var time = parts[0];
        var modifier = parts[1].toUpperCase();

        var timeParts = time.split(':');
        if (timeParts.length !== 2) {
            console.error('Invalid time parts:', time);
            return '08:30';
        }

        var hours = parseInt(timeParts[0]);
        var minutes = timeParts[1];

        // Convert to 24-hour format
        if (modifier === 'PM' && hours !== 12) {
            hours = hours + 12;
        } else if (modifier === 'AM' && hours === 12) {
            hours = 0;
        }

        // Ensure two-digit format
        hours = hours.toString().padStart(2, '0');

        var result = hours + ':' + minutes;
        console.log('Converted', time12, 'to', result);
        return result;
    }

    // Destroy all Flatpickr instances
    function destroyAllFlatpickrs() {
        for (var key in flatpickrInstances) {
            if (flatpickrInstances[key]) {
                flatpickrInstances[key].destroy();
                delete flatpickrInstances[key];
            }
        }
    }

    // Initialize Flatpickr time pickers
    function initializeTimePickers() {
        // Destroy existing instances first
        destroyAllFlatpickrs();

        // Initialize time-in pickers
        $('.time-in').each(function() {
            var $this = $(this);
            var currentValue = $this.val() || defaultConfig.DefaultTimeIn || '8:30 AM';
            var studentId = $this.data('studentid');
            var instanceKey = 'timein_' + studentId;

            // Ensure data-time24 is set initially
            if (!$this.attr('data-time24')) {
                $this.attr('data-time24', convertTo24Hour(currentValue));
            }

            // Create Flatpickr instance
            flatpickrInstances[instanceKey] = flatpickr($this[0], {
                enableTime: true,
                noCalendar: true,
                dateFormat: "h:i K",  // 12-hour format with AM/PM
                time_24hr: false,
                defaultDate: currentValue,
                minuteIncrement: 15,
                onChange: function(selectedDates, dateStr, instance) {
                    var time24 = convertTo24Hour(dateStr);
                    var oldTime24 = $this.attr('data-time24');

                    if (oldTime24 !== time24) {
                        $this.attr('data-time24', time24);
                        console.log('Time-IN changed:',
                                   'Student:', studentId,
                                   'Old:', oldTime24,
                                   'New 12hr:', dateStr,
                                   'New 24hr:', time24);
                        trackModification($this);
                    }
                }
            });
        });

        // Initialize time-out pickers
        $('.time-out').each(function() {
            var $this = $(this);
            var currentValue = $this.val() || defaultConfig.DefaultTimeOut || '2:45 PM';
            var studentId = $this.data('studentid');
            var instanceKey = 'timeout_' + studentId;

            // Ensure data-time24 is set initially
            if (!$this.attr('data-time24')) {
                $this.attr('data-time24', convertTo24Hour(currentValue));
            }

            // Create Flatpickr instance
            flatpickrInstances[instanceKey] = flatpickr($this[0], {
                enableTime: true,
                noCalendar: true,
                dateFormat: "h:i K",  // 12-hour format with AM/PM
                time_24hr: false,
                defaultDate: currentValue,
                minuteIncrement: 15,
                onChange: function(selectedDates, dateStr, instance) {
                    var time24 = convertTo24Hour(dateStr);
                    var oldTime24 = $this.attr('data-time24');

                    if (oldTime24 !== time24) {
                        $this.attr('data-time24', time24);
                        console.log('Time-OUT changed:',
                                   'Student:', studentId,
                                   'Old:', oldTime24,
                                   'New 12hr:', dateStr,
                                   'New 24hr:', time24);
                        trackModification($this);
                    }
                }
            });
        });
    }

    // Toast notification function
    function showToast(message, type, duration) {
        type = type || 'success';
        duration = duration || 4000;

        var icons = {
            success: 'check-circle',
            error: 'times-circle',
            warning: 'exclamation-triangle',
            info: 'info-circle'
        };

        var toastId = 'toast_' + Date.now();
        var toastHtml =
            '<div class="toast toast-' + type + '" id="' + toastId + '" style="display:none;">' +
                '<i class="fas fa-' + icons[type] + ' me-2"></i>' +
                message +
            '</div>';

        $('#toastContainer').append(toastHtml);
        $('#' + toastId).fadeIn(300);

        setTimeout(function() {
            $('#' + toastId).fadeOut(300, function() {
                $(this).remove();
            });
        }, duration);
    }

    // Show/Hide spinner
    function showSpinner() {
        $('#spinnerOverlay').css('display', 'flex');
    }

    function hideSpinner() {
        $('#spinnerOverlay').hide();
    }

    // Configuration for restricted days
    var restrictedDays = {
        sunday: true,      // Set to true to restrict Sunday
        saturday: false,   // Set to true to restrict Saturday as well
        autoAdjust: true  // Automatically adjust to next valid day
    };

    // Get next valid date from a restricted day
    function getNextValidDate(dateString) {
        var date = new Date(dateString);
        var dayOfWeek = date.getDay();

        // If Sunday and restricted, move to Monday
        if (dayOfWeek === 0 && restrictedDays.sunday) {
            date.setDate(date.getDate() + 1);
        }
        // If Saturday and restricted, move to Monday
        else if (dayOfWeek === 6 && restrictedDays.saturday) {
            date.setDate(date.getDate() + 2);
        }

        // Format date as YYYY-MM-DD
        var year = date.getFullYear();
        var month = String(date.getMonth() + 1).padStart(2, '0');
        var day = String(date.getDate()).padStart(2, '0');

        return year + '-' + month + '-' + day;
    }

    // Check if date is a restricted day
    function isRestrictedDay(dateString) {
        var date = new Date(dateString);
        var dayOfWeek = date.getDay();

        if (restrictedDays.sunday && dayOfWeek === 0) {
            return { restricted: true, dayName: 'Sunday' };
        }
        if (restrictedDays.saturday && dayOfWeek === 6) {
            return { restricted: true, dayName: 'Saturday' };
        }

        return { restricted: false, dayName: null };
    }

    // Get day name from date
    function getDayName(dateString) {
        var days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
        var date = new Date(dateString);
        return days[date.getDay()];
    }

    // Search button click
    $('#btnSearch').click(function() {
        var classId = $('#ddlClass').val();
        var sectionId = $('#ddlSection').val();
        var date = $('#attendanceDate').val();
        currentClassId = classId;
        currentSectionId = sectionId;
        currentDate = date;

        var errors = [];
        if (!classId) errors.push('Please select a class');
        if (!sectionId) errors.push('Please select a section');
        if (!date) errors.push('Please select a date');

        if (errors.length > 0) {
            showToast(errors.join(', '), 'warning');
            return;
        }

        // Check if selected date is a restricted day
        var restrictionCheck = isRestrictedDay(date);
        if (restrictionCheck.restricted) {
            if (restrictedDays.autoAdjust) {
                // Auto-adjust to next valid date
                var nextValidDate = getNextValidDate(date);
                var nextDayName = getDayName(nextValidDate);

                showToast('Cannot mark attendance for ' + restrictionCheck.dayName +
                         '! Automatically adjusted to ' + nextDayName + '.', 'info', 5000);

                // Set the new date
                $('#attendanceDate').val(nextValidDate);
                currentDate = nextValidDate;

                // Trigger change event to update validation
                $('#attendanceDate').trigger('change');

                // Load data for the adjusted date
                setTimeout(function() {
                    loadAttendanceData(classId, sectionId, nextValidDate);
                }, 500);
            } else {
                // Don't auto-adjust, just show error
                showToast('Attendance cannot be marked for ' + restrictionCheck.dayName + '! ' +
                         restrictionCheck.dayName + ' is a holiday. Please select a working day.', 'error', 5000);

                // Hide attendance container if it was visible
                $('#attendanceContainer').hide();
                if (dataTable) {
                    dataTable.destroy();
                    dataTable = null;
                }

                return; // Don't proceed with loading students
            }
        } else {
            // Valid date - proceed normally
            var dayName = getDayName(date);
            console.log('Selected day:', dayName);
            loadAttendanceData(classId, sectionId, date);
        }
    });

    // Load attendance data
    function loadAttendanceData(classId, sectionId, date) {
        showSpinner();

        $.ajax({
            url: '@Url.Action("GetStudentsForAttendance", "Attendance")',
            type: 'POST',
            data: {
                classId: classId,
                sectionId: sectionId,
                attendanceDate: date
            },
            success: function(response) {
                hideSpinner();

                if (response.success) {
                    studentsData = response.students;

                    // IMPORTANT: Store the config from server response
                    if (response.config) {
                        defaultConfig = response.config;
                        console.log('Config received from server:', defaultConfig);
                        console.log('Default TimeIn:', defaultConfig.DefaultTimeIn);
                        console.log('Default TimeOut:', defaultConfig.DefaultTimeOut);
                    }

                    originalAttendance = {};
                    modifiedAttendance = {};

                    // Store original attendance
                    if (response.existingAttendance) {
                        $.each(response.existingAttendance, function(i, att) {
                            originalAttendance[att.StudentID] = {
                                Status: att.Status,
                                TimeIn: att.TimeIn,
                                TimeOut: att.TimeOut,
                                Note: att.Note
                            };
                        });
                    }

                    displayAttendanceGrid(response);
                    $('#attendanceContainer').show();
                    showToast('Data loaded successfully! ' + response.students.length + ' students found', 'success');

                    if (response.isHoliday) {
                        showToast('Note: Selected date is a holiday', 'info');
                    }
                } else {
                    showToast(response.message || 'Failed to load data', 'error');
                }
            },
            error: function(xhr, status, error) {
                hideSpinner();
                showToast('An error occurred while loading data', 'error');
                console.error('Load error:', error);
            }
        });
    }

    // Display attendance grid with DataTable
    function displayAttendanceGrid(data) {
        if (!data.students || data.students.length === 0) {
            $('#attendanceContainer').html(
                '<div class="alert alert-info">' +
                    '<i class="fas fa-info-circle me-2"></i>' +
                    'No students found for the selected criteria' +
                '</div>'
            );
            return;
        }

        // Update student count
        $('#studentCount').text(data.students.length + ' students');

        // Update class info
        $('#classInfo').text('Student List');

        // Build table body
        var bodyHtml = '';
        $.each(data.students, function(index, student) {
            var existingAtt = originalAttendance[student.StudentID] || {};
            var status = existingAtt.Status || student.Status || 'Present';

            // FIXED: Use config defaults properly
            // Convert config times to 24-hour format
            var defaultTimeIn24 = convertTo24Hour(defaultConfig.DefaultTimeIn || '8:30 AM');
            var defaultTimeOut24 = convertTo24Hour(defaultConfig.DefaultTimeOut || '2:45 PM');

            // Get time values with proper fallback to config defaults
            var timeIn = existingAtt.TimeIn || student.TimeIn || defaultTimeIn24;
            var timeOut = existingAtt.TimeOut || student.TimeOut || defaultTimeOut24;
            var note = existingAtt.Note || student.Note || '';

            // Ensure times are in proper 24-hour format (if they're not already)
            if (timeIn && (timeIn.includes('AM') || timeIn.includes('PM'))) {
                timeIn = convertTo24Hour(timeIn);
            }
            if (timeOut && (timeOut.includes('AM') || timeOut.includes('PM'))) {
                timeOut = convertTo24Hour(timeOut);
            }

            // Convert times to 12-hour format for display
            var timeIn12 = convertTo12Hour(timeIn);
            var timeOut12 = convertTo12Hour(timeOut);

            console.log('Student:', student.StudentName,
                       'TimeIn:', timeIn, '->', timeIn12,
                       'TimeOut:', timeOut, '->', timeOut12,
                       'Using Config Defaults:', defaultConfig.DefaultTimeIn, defaultConfig.DefaultTimeOut);

            bodyHtml += '<tr data-studentid="' + student.StudentID + '">' +
                     '<td class="text-center"><input type="checkbox" class="student-checkbox row-checkbox"></td>' +
                     '<td>' + student.AdmissionNo + '</td>' +
                     '<td>' + student.ClassName + '-' + student.SectionName + '</td>' +
                     '<td>' + (student.MobileNumber || '-') + '</td>' +
                     '<td class="student-info-cell"><strong>' + student.StudentName + '</strong></td>' +
                     '<td class="student-info-cell">' + student.FatherName + '</td>' +
                     '<td><span class="badge bg-danger">' + (student.RollNumber || '-') + '</span></td>' +
                     '<td>' +
                        '<select class="status-dropdown" ' +
                        'data-studentid="' + student.StudentID + '" ' +
                        'data-original="' + status + '">' +
                            '<option value="Present"' + (status === 'Present' ? ' selected' : '') + '>Present</option>' +
                            '<option value="Absent"' + (status === 'Absent' ? ' selected' : '') + '>Absent</option>' +
                            '<option value="Late"' + (status === 'Late' ? ' selected' : '') + '>Late</option>' +
                            '<option value="Half Day"' + (status === 'Half Day' ? ' selected' : '') + '>Half Day</option>' +
                            '<option value="Holiday"' + (status === 'Holiday' ? ' selected' : '') + '>Holiday</option>' +
                        '</select>' +
                     '</td>' +
                     '<td>Manual</td>' +
                     '<td><input type="text" class="time-input time-in" ' +
                        'data-studentid="' + student.StudentID + '" ' +
                        'data-original="' + timeIn + '" ' +
                        'data-time24="' + timeIn + '" ' +
                        'value="' + timeIn12 + '"></td>' +
                     '<td><input type="text" class="time-input time-out" ' +
                        'data-studentid="' + student.StudentID + '" ' +
                        'data-original="' + timeOut + '" ' +
                        'data-time24="' + timeOut + '" ' +
                        'value="' + timeOut12 + '"></td>' +
                     '<td><input maxlength="50" type="text" class="note-input" ' +
                        'data-studentid="' + student.StudentID + '" ' +
                        'data-original="' + note + '" ' +
                        'placeholder="Note" value="' + note + '"></td>' +
                     '</tr>';
        });

        $('#attendanceTableBody').html(bodyHtml);

        // Initialize DataTable
        initializeDataTable();
    }

    // Initialize DataTable
    function initializeDataTable() {
        // Destroy existing DataTable if exists
        if (dataTable) {
            dataTable.destroy();
        }

        // Calculate which columns should be exportable (exclude checkbox column)
        var exportColumns = [];
        for (var i = 1; i < $('#tableHeader th').length; i++) {
            exportColumns.push(i);
        }

        // Initialize new DataTable
        dataTable = $('#attendanceDataTable').DataTable({
            "paging": false,
            "info": false,
            "pageLength": -1, // Always show all
            "order": [[1, "asc"]], // Order by SR
            "scrollX": true,
            "lengthChange": false, // hides the length menu dropdown
            "responsive": false,
            "dom": 'Bfrtip',
            "buttons": [
                {
                    extend: 'copy',
                    text: 'Copy',
                    className: 'dt-button',
                    exportOptions: {
                        columns: exportColumns
                    }
                },
                {
                    extend: 'csv',
                    text: 'CSV',
                    className: 'dt-button',
                    title: 'AttendanceReport_' + new Date().getTime(),
                    exportOptions: {
                        columns: exportColumns
                    }
                },
                {
                    extend: 'excel',
                    text: 'Excel',
                    className: 'dt-button',
                    title: 'AttendanceReport_' + new Date().getTime(),
                    exportOptions: {
                        columns: exportColumns
                    }
                },
                {
                    extend: 'pdf',
                    text: 'PDF',
                    className: 'dt-button',
                    title: 'Attendance Report',
                    orientation: 'landscape',
                    pageSize: 'A4',
                    exportOptions: {
                        columns: exportColumns
                    }
                },
                {
                    extend: 'print',
                    text: 'Print',
                    className: 'dt-button',
                    title: 'Attendance Report',
                    exportOptions: {
                        columns: exportColumns
                    }
                }
            ],
            "language": {
                "search": "Search students:",
                "lengthMenu": "Show _MENU_ entries",
                "info": "Showing _START_ to _END_ of _TOTAL_ students",
                "paginate": {
                    "first": "First",
                    "last": "Last",
                    "next": "Next",
                    "previous": "Previous"
                }
            },
            "columnDefs": [
                {
                    "orderable": false,
                    "targets": [0] // Disable ordering for checkbox column
                }
            ],
            "drawCallback": function(settings) {
                // Re-bind events after DataTable redraw
                bindAttendanceEvents();
                updateAttendanceSummary();
            }
        });

        // Initial binding
        bindAttendanceEvents();
        updateAttendanceSummary();
    }

    // Bind attendance events
    function bindAttendanceEvents() {
        // Remove ALL previous event handlers to prevent duplicates
        $('.status-dropdown').off();
        $('.note-input').off();
        $('#selectAll').off();
        $('.row-checkbox').off();

        // Initialize time pickers with Flatpickr
        initializeTimePickers();

        // Status change
        $('.status-dropdown').on('change', function() {
            var $this = $(this);
            updateStatusColor($this);
            trackModification($this);
            updateAttendanceSummary();
        });

        // Note changes
        $('.note-input').on('change input', function() {
            trackModification($(this));
        });

        // Select all checkbox
        $('#selectAll').on('change', function() {
            var isChecked = $(this).prop('checked');
            if (dataTable) {
                dataTable.$('.row-checkbox').prop('checked', isChecked);
                if (isChecked) {
                    dataTable.$('tr').addClass('selected-row');
                } else {
                    dataTable.$('tr').removeClass('selected-row');
                }
            }
        });

        // Individual row checkbox
        $('.row-checkbox').on('change', function() {
            var $row = $(this).closest('tr');
            if ($(this).is(':checked')) {
                $row.addClass('selected-row');
            } else {
                $row.removeClass('selected-row');
            }

            // Update select all checkbox
            var totalCheckboxes = $('.row-checkbox').length;
            var checkedCheckboxes = $('.row-checkbox:checked').length;
            $('#selectAll').prop('checked', totalCheckboxes === checkedCheckboxes);
        });

        // Apply initial status colors
        $('.status-dropdown').each(function() {
            updateStatusColor($(this));
        });
    }

    // Update status color
    function updateStatusColor($select) {
        var status = $select.val();
        $select.removeClass('status-present status-absent status-late status-halfday status-holiday');

        switch(status) {
            case 'Present':
                $select.addClass('status-present');
                break;
            case 'Absent':
                $select.addClass('status-absent');
                break;
            case 'Late':
                $select.addClass('status-late');
                break;
            case 'Half Day':
                $select.addClass('status-halfday');
                break;
            case 'Holiday':
                $select.addClass('status-holiday');
                break;
        }
    }

    // Track modifications
    function trackModification($element) {
        var studentId = $element.data('studentid');
        if (!studentId) {
            console.warn('No student ID found for element:', $element);
            return;
        }

        var $row = $element.closest('tr');
        if ($row.length === 0) {
            console.warn('No row found for element:', $element);
            return;
        }

        // Get current time values - prioritize data-time24 attribute
        var $timeIn = $row.find('.time-in');
        var $timeOut = $row.find('.time-out');

        var timeInValue = $timeIn.attr('data-time24');
        var timeOutValue = $timeOut.attr('data-time24');

        // If data-time24 not set, convert from display value
        if (!timeInValue || timeInValue === 'undefined') {
            var timeIn12 = $timeIn.val();
            if (timeIn12 && (timeIn12.includes('AM') || timeIn12.includes('PM'))) {
                timeInValue = convertTo24Hour(timeIn12);
                $timeIn.attr('data-time24', timeInValue);
            } else {
                timeInValue = timeIn12 || convertTo24Hour(defaultConfig.DefaultTimeIn || '08:30 AM');
            }
        }

        if (!timeOutValue || timeOutValue === 'undefined') {
            var timeOut12 = $timeOut.val();
            if (timeOut12 && (timeOut12.includes('AM') || timeOut12.includes('PM'))) {
                timeOutValue = convertTo24Hour(timeOut12);
                $timeOut.attr('data-time24', timeOutValue);
            } else {
                timeOutValue = timeOut12 || convertTo24Hour(defaultConfig.DefaultTimeOut || '2:45 PM');
            }
        }

        var currentData = {
            Status: $row.find('.status-dropdown').val(),
            TimeIn: timeInValue,
            TimeOut: timeOutValue,
            Note: $row.find('.note-input').val()
        };

        // Use config defaults for original data comparison
        var originalData = originalAttendance[studentId] || {
            Status: 'Present',
            TimeIn: convertTo24Hour(defaultConfig.DefaultTimeIn || '08:30 AM'),
            TimeOut: convertTo24Hour(defaultConfig.DefaultTimeOut || '2:45 PM'),
            Note: ''
        };

        console.log('Tracking modification for student:', studentId);
        console.log('Current data:', currentData);
        console.log('Original data:', originalData);

        // Check if data has changed
        var hasChanged = JSON.stringify(currentData) !== JSON.stringify(originalData);

        if (hasChanged) {
            modifiedAttendance[studentId] = currentData;
            $row.addClass('modified-row');
            console.log('Data changed - marked as modified');
        } else {
            delete modifiedAttendance[studentId];
            $row.removeClass('modified-row');
            console.log('Data unchanged - removed modification');
        }

        // Enable/disable save button
        //$('#btnSave').prop('disabled', Object.keys(modifiedAttendance).length === 0);
    }

    // Update attendance summary
    function updateAttendanceSummary() {
        var presentCount = 0;
        var absentCount = 0;
        var totalCount = 0;

        if (dataTable) {
            dataTable.$('.status-dropdown').each(function() {
                totalCount++;
                var status = $(this).val();
                if (status === 'Present') {
                    presentCount++;
                } else if (status === 'Absent') {
                    absentCount++;
                }
            });
        }

        $('#studentCount').text(totalCount + ' students');
        $('#presentCount').text(presentCount + ' present');
        $('#absentCount').text(absentCount + ' absent');
    }

    // Apply batch status
    window.applyBatchStatus = function() {
        var status = $('#batchStatus').val();
        if (!status) {
            showToast('Please select a status', 'error');
            return;
        }

        var checkedCount = 0;

        if (dataTable) {
            dataTable.$('.row-checkbox:checked').each(function() {
                var $row = $(this).closest('tr');
                var $dropdown = $row.find('.status-dropdown');
                $dropdown.val(status);
                updateStatusColor($dropdown);
                trackModification($dropdown);
                checkedCount++;
            });
        }

        if (checkedCount === 0) {
            showToast('Please select students first', 'error');
        } else {
            showToast('Status applied to ' + checkedCount + ' students', 'success');
            $('#batchStatus').val('');
            updateAttendanceSummary();
        }
    };

    // Save attendance
    $('#btnSave').click(function() {
        if (!confirm('Do you want to save attendance for all students?')) {
            return;
        }

        var attendanceData = [];
        var debugData = []; // For debugging

        if (dataTable) {
            dataTable.$('tbody tr').each(function() {
                var $row = $(this);
                var studentId = $row.data('studentid');
                var $timeIn = $row.find('.time-in');
                var $timeOut = $row.find('.time-out');

                // Debug: Log current state
                console.log('=====================================');
                console.log('Processing Student ID:', studentId);
                console.log('Time-IN element value:', $timeIn.val());
                console.log('Time-IN data-time24:', $timeIn.attr('data-time24'));
                console.log('Time-OUT element value:', $timeOut.val());
                console.log('Time-OUT data-time24:', $timeOut.attr('data-time24'));

                // Method 1: Try to get from data-time24 attribute
                var timeInValue = $timeIn.attr('data-time24');
                var timeOutValue = $timeOut.attr('data-time24');

                // Method 2: If no data-time24, get current display value and convert
                if (!timeInValue || timeInValue === 'undefined') {
                    var timeIn12 = $timeIn.val();
                    console.log('Converting Time-IN from display:', timeIn12);
                    if (timeIn12) {
                        if (timeIn12.includes('AM') || timeIn12.includes('PM')) {
                            timeInValue = convertTo24Hour(timeIn12);
                        } else {
                            timeInValue = timeIn12; // Already in 24-hour format
                        }
                    } else {
                        timeInValue = convertTo24Hour(defaultConfig.DefaultTimeIn || '08:30 AM');
                    }
                }

                if (!timeOutValue || timeOutValue === 'undefined') {
                    var timeOut12 = $timeOut.val();
                    console.log('Converting Time-OUT from display:', timeOut12);
                    if (timeOut12) {
                        if (timeOut12.includes('AM') || timeOut12.includes('PM')) {
                            timeOutValue = convertTo24Hour(timeOut12);
                        } else {
                            timeOutValue = timeOut12; // Already in 24-hour format
                        }
                    } else {
                        timeOutValue = convertTo24Hour(defaultConfig.DefaultTimeOut || '2:45 PM');
                    }
                }

                console.log('FINAL Time-IN to save:', timeInValue);
                console.log('FINAL Time-OUT to save:', timeOutValue);
                console.log('=====================================');

                var attendanceRecord = {
                    StudentID: studentId,
                    Status: $row.find('.status-dropdown').val(),
                    TimeIn: timeInValue,
                    TimeOut: timeOutValue,
                    Note: $row.find('.note-input').val()
                };

                attendanceData.push(attendanceRecord);

                // Store for final debug output
                debugData.push({
                    StudentID: studentId,
                    TimeIn: timeInValue,
                    TimeOut: timeOutValue
                });
            });
        }

        if (attendanceData.length === 0) {
            showToast('No data to save', 'error');
            return;
        }

        // Final debug output - what we're sending to server
        console.log('===== FINAL DATA BEING SENT TO SERVER =====');
        console.log('Total Records:', attendanceData.length);
        console.table(debugData);
        console.log('Full Payload:', JSON.stringify({
            Attendance: attendanceData,
            ClassId: currentClassId,
            SectionId: currentSectionId,
            AttendanceDate: currentDate
        }, null, 2));
        console.log('============================================');

        showSpinner();
        $('#btnSave').prop('disabled', true)
            .html('<i class="fas fa-spinner fa-spin me-2"></i>Saving...');

        $.ajax({
            url: '@Url.Action("SaveAttendance", "Attendance")',
            type: 'POST',
            data: JSON.stringify({
                Attendance: attendanceData,
                ClassId: currentClassId,
                SectionId: currentSectionId,
                AttendanceDate: currentDate
            }),
            contentType: 'application/json',
            success: function(response) {
                hideSpinner();

                if (response.success) {
                    showToast(response.message || 'Attendance saved successfully!', 'success');

                    // Reload the page after 1 second
                    setTimeout(function() {
                        location.reload();
                    }, 1000);

                } else {
                    showToast(response.message || 'Failed to save', 'error');
                    $('#btnSave').html('<i class="fas fa-save me-2"></i>Save Attendance')
                        .prop('disabled', false);
                }
            },
            error: function(xhr, status, error) {
                hideSpinner();
                showToast('An error occurred while saving', 'error');
                console.error('Save error:', error);
                console.error('Server response:', xhr.responseText);
                $('#btnSave').html('<i class="fas fa-save me-2"></i>Save Attendance')
                    .prop('disabled', false);
            }
        });
    });

    // Export to Excel using DataTable
    $('#btnExportData').click(function() {
        if (dataTable) {
            $('.dt-button.buttons-excel').click();
        } else {
            showToast('Please load data first', 'warning');
        }
    });

    // Hide container when filters change and cleanup Flatpickr instances
    $('#ddlClass, #ddlSection, #attendanceDate').change(function() {
        $('#attendanceContainer').hide();
        if (dataTable) {
            dataTable.destroy();
            dataTable = null;
        }
        destroyAllFlatpickrs(); // Clean up Flatpickr instances
        modifiedAttendance = {};
        originalAttendance = {};
    });

    // Add date change validation
    $('#attendanceDate').change(function() {
        var selectedDate = $(this).val();

        if (selectedDate) {
            var restrictionCheck = isRestrictedDay(selectedDate);

            if (restrictionCheck.restricted) {
                // Show validation message
                $('#dateValidationMsg').html(
                    '<i class="fas fa-exclamation-circle"></i> ' +
                    restrictionCheck.dayName + ' is a holiday. Please select a working day (Monday to Friday).'
                ).addClass('show');

                // Show toast notification
                showToast('Warning: ' + restrictionCheck.dayName + ' is not allowed for attendance!', 'error', 5000);

                // Add red border to indicate invalid selection
                $(this).addClass('border-danger');

                // Disable search button and change its appearance
                $('#btnSearch').prop('disabled', true)
                              .removeClass('search-button')
                              .addClass('btn-secondary')
                              .html('<i class="fas fa-ban me-2"></i>Cannot Search (' + restrictionCheck.dayName + ' Selected)');
            } else {
                // Valid date selected
                var dayName = getDayName(selectedDate);
                console.log('Valid day selected:', dayName);

                // Hide validation message
                $('#dateValidationMsg').removeClass('show');

                // Remove red border if date is valid
                $(this).removeClass('border-danger');

                // Enable search button and restore its appearance
                $('#btnSearch').prop('disabled', false)
                              .removeClass('btn-secondary')
                              .addClass('search-button')
                              .html('<i class="fas fa-search me-2"></i>Search');
            }
        } else {
            // No date selected
            $('#dateValidationMsg').removeClass('show');
            $(this).removeClass('border-danger');
            $('#btnSearch').prop('disabled', false)
                          .removeClass('btn-secondary')
                          .addClass('search-button')
                          .html('<i class="fas fa-search me-2"></i>Search');
        }
    });

    // Check initial date on page load
    var initialDate = $('#attendanceDate').val();
    if (initialDate) {
        $('#attendanceDate').trigger('change');
    }

    // Set max date to today and min date (optional)
    var today = new Date();
    var dd = String(today.getDate()).padStart(2, '0');
    var mm = String(today.getMonth() + 1).padStart(2, '0');
    var yyyy = today.getFullYear();
    var todayString = yyyy + '-' + mm + '-' + dd;

    // Set max date to today (can't mark future attendance)
    $('#attendanceDate').attr('max', todayString);

    // Cleanup on page unload
    $(window).on('beforeunload', function() {
        destroyAllFlatpickrs();
    });
});
</script>
