@model ERPIndia.Controllers.ExamScheduleViewModel

@{
    ViewBag.Title = "Exam Schedule";
}

<link href="~/Content/model.css" rel="stylesheet" />

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-calendar-alt me-2"></i>Exam Schedule
                    </h5>
                </div>
                <div class="card-body">
                    @if (TempData["Success"] != null)
                    {
                        <div class="alert alert-success alert-dismissible fade show" role="alert">
                            @TempData["Success"]
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    }

                    <div id="validationMessage" class="alert alert-warning d-none">
                        Please select all required fields before searching.
                    </div>

                    <div id="errorMessage" class="alert alert-danger d-none"></div>

                    <form id="searchForm" class="needs-validation" novalidate>
                        <div class="row g-3">
                            <div class="col-md-3">
                                <label for="SelectedClass" class="form-label">Class <span class="text-danger">*</span></label>
                                @Html.DropDownListFor(m => m.SelectedClass, Model.ClassList, new { @class = "form-control", required = "required" })
                                <div class="invalid-feedback">
                                    Please select a class.
                                </div>
                            </div>
                            <div class="col-md-3">
                                <label for="SelectedSection" class="form-label">Section <span class="text-danger">*</span></label>
                                @Html.DropDownListFor(m => m.SelectedSection, Model.SectionList, new { @class = "form-control", required = "required" })
                                <div class="invalid-feedback">
                                    Please select a section.
                                </div>
                            </div>
                            <div class="col-md-3">
                                <label for="SelectedExam" class="form-label">Exam <span class="text-danger">*</span></label>
                                @Html.DropDownListFor(m => m.SelectedExam, Model.ExamList, new { @class = "form-control", required = "required" })
                                <div class="invalid-feedback">
                                    Please select an exam.
                                </div>
                            </div>
                            <div class="col-md-3 align-self-end">
                                <div class="d-grid gap-2">
                                    <button type="button" id="btnSearch" class="btn btn-primary">
                                        <i class="fas fa-search me-2"></i>Generate Schedule
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Schedule Table Container -->
    <div id="scheduleTableContainer" class="mt-4">
        <!-- Partial view will be loaded here -->
    </div>
</div>

    <script>
        $(document).ready(function () {
            // Initialize form validation
            var forms = document.querySelectorAll('.needs-validation');
            Array.prototype.slice.call(forms).forEach(function (form) {
                form.addEventListener('submit', function (event) {
                    event.preventDefault();
                    event.stopPropagation();
                }, false);
            });

            // Search button click handler
            $('#btnSearch').click(function () {
                var classId = $('#SelectedClass').val();
                var sectionId = $('#SelectedSection').val();
                var examId = $('#SelectedExam').val();

                // Clear previous messages
                $('#validationMessage').addClass('d-none');
                $('#errorMessage').addClass('d-none').text('');

                // Validate selections
                if (!classId || classId === '00000000-0000-0000-0000-000000000000' ||
                    !sectionId || sectionId === '00000000-0000-0000-0000-000000000000' ||
                    !examId || examId === '00000000-0000-0000-0000-000000000000') {
                    $('#validationMessage').removeClass('d-none');
                    return;
                }

                // Show loading indicator
                $('#btnSearch').prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-2"></i>Loading...');

                // AJAX call to generate schedule
                $.ajax({
                    url: '@Url.Action("GenerateSchedule", "ExamSchedule")',
                    type: 'POST',
                    data: {
                        SelectedClass: classId,
                        SelectedSection: sectionId,
                        SelectedExam: examId
                    },
                    success: function (response) {
                        if (response.success === false) {
                            $('#errorMessage').text(response.message).removeClass('d-none');
                        } else {
                            $('#scheduleTableContainer').html(response);
                            // Initialize date change event handlers for the new content
                            initializeDateHandlers();
                        }
                    },
                    error: function (xhr, status, error) {
                        $('#errorMessage').text('An error occurred while loading subjects. Please try again.').removeClass('d-none');
                        console.error('Error:', error);
                    },
                    complete: function () {
                        $('#btnSearch').prop('disabled', false).html('<i class="fas fa-search me-2"></i>Generate Schedule');
                    }
                });
            });

            // Initialize date handlers
            function initializeDateHandlers() {
                // Auto-populate day when date is selected
                $(document).on('change', 'input[type="date"]', function () {
                    var selectedDate = $(this).val();
                    if (selectedDate) {
                        var date = new Date(selectedDate);
                        var days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
                        var dayName = days[date.getDay()];

                        // Find the corresponding day input
                        var dayInput = $(this).closest('tr').find('input[id*="Day"]');
                        dayInput.val(dayName);
                    }
                });
            }
            
        });
    </script>
