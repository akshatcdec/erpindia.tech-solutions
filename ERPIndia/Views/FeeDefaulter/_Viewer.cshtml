@model ERPIndia.Controllers.StudentFeeLedgerViewModel
@using ERPIndia.Class.Helper
@using CrystalDecisions.CrystalReports.Engine
@using CrystalDecisions.Shared
@using System.IO
@using System.Data
@using ERPIndia
@{
    // Crystal Report settings
    string reportPath = Server.MapPath("~/Reports/CrystalReport/0/studentfeeledger.rpt");
    ReportDocument reportDocument = new ReportDocument();
    try
    {
        // Load the report
        reportDocument.Load(reportPath);
        // Set data source directly
        if (Model.Students != null && Model.Students.Count > 0)
        {
            // Convert data to DataTable if needed
            var dataTable = ERPIndia.Utils.ConvertToDataTable(Model.Students);
            reportDocument.SetDataSource(dataTable);
            // Get tenant code from the first student record
            string code = CommonLogic.GetSessionValue(StringConstants.TenantCode);
            string sessionprint = "Session ( " +CommonLogic.GetSessionValue(StringConstants.ActiveSessionPrint)+" )";
            string img = CommonLogic.GetSessionValue(StringConstants.LogoImg);
            string logoPath = Server.MapPath(ERPIndia.Class.Helper.AppLogic.GetLogoImage(code, img));
            // Load the report
            reportDocument.SetParameterValue("prmreportlogo", logoPath);
            reportDocument.SetParameterValue("prmtitle", "");
            reportDocument.SetParameterValue("prmline1", "");
            reportDocument.SetParameterValue("prmline2", "");
            reportDocument.SetParameterValue("prmline3", "");
            reportDocument.SetParameterValue("prmline4", "");
            reportDocument.SetParameterValue("prmreportname", "");
            reportDocument.SetParameterValue("prmreportitle1", sessionprint);
            reportDocument.SetParameterValue("prmreportitle2", Model.SelectedMonthDisplayText);
         
            // Pass your data to the report


            // Set report parameters if needed

            // Generate a unique identifier for the report
            string reportId = "StudentFeeLedger_" + DateTime.Now.ToString("yyyyMMddHHmmss");

            // Store the report document in session for later retrieval
            Session[reportId] = reportDocument;

            // Display the report using an iframe that calls an action to stream the PDF
            <div class="text-center">
                <iframe src="@Url.Action("StreamReport", "Student", new { id = reportId })"
                        class="w-100" style="height: 600px; border: none;"></iframe>
            </div>
            <script>
                $(window).on('beforeunload', function() {
                    // Get the report ID from the iframe src
                    var iframeSrc = $('iframe').attr('src');
                    if (iframeSrc) {
                        var reportId = iframeSrc.split('id=')[1];
                        if (reportId) {
                            // Make an async call to clean up the report
                            $.ajax({
                                url: '@Url.Action("CleanupReport", "Student")',
                                data: { id: reportId },
                                async: false
                            });
                        }
                    }
                });
            </script>
        }
        else
        {
            <div class="alert alert-warning">
                <strong>No data available:</strong> There are no records to display in the report.
            </div>
            // Clean up if no data
            reportDocument.Close();
            reportDocument.Dispose();
        }
    }
    catch (Exception ex)
    {
        <div class="alert alert-danger">
            <strong>Error loading report:</strong> @ex.Message
        </div>
        // Clean up on error
        if (reportDocument != null)
        {
            reportDocument.Close();
            reportDocument.Dispose();
        }
    }
}